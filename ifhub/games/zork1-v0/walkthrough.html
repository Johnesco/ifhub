<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Walkthrough — Zork I (v0: Original ZIL)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  background: #0a0a0a;
  color: #d4c5a9;
  font-family: Georgia, "Times New Roman", serif;
  overflow: hidden;
}

/* --- Layout --- */
.container {
  display: flex;
  height: 100%;
}

/* --- Sidebar --- */
.sidebar {
  width: 280px;
  min-width: 280px;
  background: #0e0e0c;
  border-right: 1px solid #1e1a14;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-header {
  padding: 16px 16px 12px;
  border-bottom: 1px solid #1e1a14;
}

.sidebar-header h1 {
  font-size: 0.95em;
  color: #c4b48a;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}

.sidebar-header a {
  font-size: 0.8em;
  color: #887755;
  text-decoration: none;
  border-bottom: 1px solid transparent;
}

.sidebar-header a:hover {
  color: #aa9966;
  border-bottom-color: #aa9966;
}

.nav {
  flex: 1;
  overflow-y: auto;
  padding: 8px 0;
}

.nav::-webkit-scrollbar { width: 6px; }
.nav::-webkit-scrollbar-track { background: #0e0e0c; }
.nav::-webkit-scrollbar-thumb { background: #2a2418; border-radius: 3px; }

.nav-item {
  display: block;
  padding: 6px 16px;
  font-size: 0.85em;
  color: #998866;
  text-decoration: none;
  cursor: pointer;
  border-left: 2px solid transparent;
  transition: background 0.1s, color 0.1s;
}

.nav-item:hover {
  background: #151510;
  color: #c4b48a;
}

.nav-item.active {
  background: #18160f;
  color: #e8d090;
  border-left-color: #e8d090;
}

/* --- Main content --- */
.main {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.toolbar {
  padding: 8px 20px;
  background: #0e0e0c;
  border-bottom: 1px solid #1e1a14;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.85em;
  color: #887755;
  flex-wrap: wrap;
}

.toolbar .file-path {
  font-family: "SF Mono", "Fira Code", Consolas, "Courier New", monospace;
  font-size: 0.9em;
  color: #aa9966;
}

.toolbar .step-count {
  margin-left: auto;
}

.search-box {
  background: #111;
  border: 1px solid #2a2418;
  border-radius: 4px;
  color: #d4c5a9;
  font-family: "SF Mono", "Fira Code", Consolas, "Courier New", monospace;
  font-size: 0.9em;
  padding: 3px 8px;
  width: 180px;
  outline: none;
}

.search-box:focus {
  border-color: #4a3a20;
}

.search-box::placeholder {
  color: #554433;
}

.toggle-btn {
  background: #1a1810;
  border: 1px solid #2a2418;
  border-radius: 4px;
  color: #887755;
  font-family: inherit;
  font-size: 0.85em;
  padding: 3px 12px;
  cursor: pointer;
  transition: background 0.15s, color 0.15s, border-color 0.15s;
  white-space: nowrap;
}

.toggle-btn:hover {
  background: #2a2010;
  color: #c4b48a;
  border-color: #4a3a20;
}

.toggle-btn.active {
  background: #2a2010;
  border-color: #5a4a30;
  color: #e8d090;
}

.dl-link {
  color: #887755;
  text-decoration: none;
  font-size: 0.9em;
  border-bottom: 1px solid transparent;
}

.dl-link:hover {
  color: #aa9966;
  border-bottom-color: #aa9966;
}

.content-wrap {
  flex: 1;
  overflow: auto;
  padding: 24px 40px 40px;
}

.content-wrap::-webkit-scrollbar { width: 8px; }
.content-wrap::-webkit-scrollbar-track { background: #0a0a0a; }
.content-wrap::-webkit-scrollbar-thumb { background: #2a2418; border-radius: 4px; }
.content-wrap::-webkit-scrollbar-thumb:hover { background: #3a3020; }

/* --- Spoiler notice --- */
.spoiler-notice {
  background: #1a1510;
  border: 1px solid #3a3020;
  border-radius: 6px;
  padding: 16px 20px;
  margin-bottom: 32px;
  font-size: 0.9em;
  color: #aa9966;
  line-height: 1.6;
}

.spoiler-notice strong {
  color: #c4b48a;
}

/* --- Section headers (all modes) --- */
.section-header {
  font-size: 1.15em;
  font-weight: bold;
  color: #e8d8b0;
  margin: 36px 0 6px;
  padding-bottom: 6px;
  border-bottom: 1px solid #2a2418;
}

.section-header:first-of-type {
  margin-top: 0;
}

.section-subtitle {
  font-size: 0.85em;
  color: #776655;
  font-weight: normal;
  margin-left: 8px;
}

/* --- Command lines (Commands mode) --- */
.command-line {
  display: flex;
  align-items: baseline;
  margin: 3px 0;
  font-family: "SF Mono", "Fira Code", Consolas, "Courier New", monospace;
  font-size: 0.9em;
}

.command-num {
  min-width: 36px;
  text-align: right;
  padding-right: 12px;
  color: #4a3a20;
  user-select: none;
  font-size: 0.85em;
}

.command-text {
  color: #8bab6e;
}

.command-prompt {
  color: #5a4a30;
  margin-right: 6px;
  user-select: none;
}

.raw-view .command-line {
  margin: 1px 0;
}

/* --- Game Text / Transcript mode --- */
.transcript-step {
  margin: 0 0 4px;
  font-family: "SF Mono", "Fira Code", Consolas, "Courier New", monospace;
  font-size: 0.88em;
  line-height: 1.5;
}

.transcript-step .step-command {
  display: flex;
  align-items: baseline;
}

.transcript-step .command-num {
  min-width: 36px;
  text-align: right;
  padding-right: 12px;
  color: #4a3a20;
  user-select: none;
  font-size: 0.85em;
  flex-shrink: 0;
}

.transcript-step .command-prompt {
  color: #e8d090;
  margin-right: 6px;
  user-select: none;
  font-weight: bold;
}

.transcript-step .command-text {
  color: #e8d090;
  font-weight: bold;
}

.transcript-step .response {
  padding-left: 48px;
  color: #b8a888;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.transcript-step .response .room-name {
  color: #e8d8b0;
  font-weight: bold;
}

.transcript-step .response .score-line {
  color: #aa9966;
  font-style: italic;
}

/* --- Preamble (Game Text) --- */
.transcript-preamble {
  font-family: "SF Mono", "Fira Code", Consolas, "Courier New", monospace;
  font-size: 0.88em;
  line-height: 1.5;
  color: #887755;
  padding-left: 48px;
  margin-bottom: 16px;
  white-space: pre-wrap;
}

/* --- Replay mode --- */
.replay-controls {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 20px;
  background: #0e0e0c;
  border-bottom: 1px solid #1e1a14;
  font-size: 0.85em;
  color: #887755;
}

.replay-controls button {
  background: #1a1810;
  border: 1px solid #2a2418;
  border-radius: 4px;
  color: #887755;
  font-family: "SF Mono", "Fira Code", Consolas, "Courier New", monospace;
  font-size: 0.85em;
  padding: 3px 10px;
  cursor: pointer;
  transition: background 0.15s, color 0.15s, border-color 0.15s;
}

.replay-controls button:hover {
  background: #2a2010;
  color: #c4b48a;
  border-color: #4a3a20;
}

.replay-controls button.active {
  background: #2a2010;
  border-color: #5a4a30;
  color: #e8d090;
}

.replay-controls .step-display {
  color: #aa9966;
  font-family: "SF Mono", "Fira Code", Consolas, "Courier New", monospace;
  font-size: 0.9em;
  min-width: 100px;
}

.progress-bar-container {
  flex: 1;
  height: 6px;
  background: #1a1810;
  border-radius: 3px;
  cursor: pointer;
  position: relative;
  min-width: 100px;
}

.progress-bar-fill {
  height: 100%;
  background: #5a4a30;
  border-radius: 3px;
  transition: width 0.1s;
}

.progress-bar-container:hover .progress-bar-fill {
  background: #7a6a40;
}

/* Blinking cursor for replay */
.typing-cursor {
  display: inline-block;
  width: 7px;
  height: 1.1em;
  background: #e8d090;
  vertical-align: text-bottom;
  animation: blink 0.7s step-end infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}

/* Fade-in for response lines in replay */
.response-line-fade {
  opacity: 0;
  transition: opacity 0.15s ease-in;
}

.response-line-fade.visible {
  opacity: 1;
}

/* --- Search highlights --- */
.search-hit {
  background: #5a4a10;
  color: #ffe8a0;
  border-radius: 2px;
}

.search-current {
  background: #7a6a20;
  outline: 1px solid #aa9930;
}

/* --- Loading / error --- */
.loading {
  text-align: center;
  padding: 80px 40px;
  color: #887755;
  font-size: 1.1em;
}

.loading em {
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.4; }
  50% { opacity: 1; }
}

.error-msg {
  text-align: center;
  padding: 80px 40px;
  color: #aa6644;
}

/* --- Responsive --- */
@media (max-width: 700px) {
  .sidebar { display: none; }
  .content-wrap { padding: 16px 20px 40px; }
  .replay-controls { flex-wrap: wrap; }
}
</style>
</head>
<body>

<div class="container">
  <div class="sidebar">
    <div class="sidebar-header">
      <h1>Walkthrough (v0)</h1>
      <a href="../">&larr; Back to project</a>
    </div>
    <div class="nav" id="nav"></div>
  </div>
  <div class="main">
    <div class="toolbar">
      <button class="toggle-btn active" id="btn-commands">Commands</button>
      <button class="toggle-btn" id="btn-transcript">Game Text</button>
      <button class="toggle-btn" id="btn-replay">Replay</button>
      <input type="text" class="search-box" id="search" placeholder="Search... (Ctrl+F)">
      <a class="dl-link" href="walkthrough.txt" download>Commands</a>
      <a class="dl-link" href="walkthrough-guide.txt" download>Guide</a>
      <span class="step-count" id="step-count"></span>
    </div>
    <div id="replay-controls" class="replay-controls" style="display:none;">
      <button id="replay-play" title="Play/Pause (Space)">&#9654; Play</button>
      <button id="replay-back" title="Step back (&larr;)">&larr;</button>
      <button id="replay-fwd" title="Step forward (&rarr;)">&rarr;</button>
      <span class="step-display" id="replay-step">Step 0/0</span>
      <div class="progress-bar-container" id="progress-bar">
        <div class="progress-bar-fill" id="progress-fill" style="width:0%"></div>
      </div>
      <button class="speed-btn" data-speed="0.5">0.5x</button>
      <button class="speed-btn active" data-speed="1">1x</button>
      <button class="speed-btn" data-speed="2">2x</button>
      <button class="speed-btn" data-speed="4">4x</button>
    </div>
    <div class="content-wrap" id="content-wrap">
      <div class="loading"><em>Loading walkthrough...</em></div>
    </div>
  </div>
</div>

<script>
var GUIDE_URL = 'walkthrough-guide.txt';
var RAW_URL = 'walkthrough.txt';
var TRANSCRIPT_URL = 'walkthrough_output.txt';

var guideData = null;
var rawData = null;
var transcriptData = null;   // parsed transcript steps
var transcriptRaw = null;    // raw transcript text
var currentView = 'commands';

// Replay state
var replayPlaying = false;
var replayStep = -1;  // -1 = preamble, 0..N-1 = steps
var replayTimer = null;
var replaySpeed = parseFloat(localStorage.getItem('zork1-replay-speed') || '1');
var replayPhase = 'idle'; // 'idle' | 'typing' | 'response' | 'pause'
var replayTypingIndex = 0;
var replayResponseIndex = 0;

function esc(s) {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

/* ---- Parse guide for section headers and command->section mapping ---- */
function parseGuide(text) {
  var lines = text.split('\n');
  var sections = [];
  var currentSection = null;
  var commandNum = 0;

  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];

    if (line.match(/^## /)) {
      var headerText = line.slice(3);
      var parts = headerText.split(' -- ');
      var title = parts[0].trim();
      var subtitle = parts.length > 1 ? parts[1].trim() : '';
      currentSection = {
        title: title, subtitle: subtitle,
        id: 'section-' + sections.length,
        items: [], firstCommand: commandNum + 1
      };
      sections.push(currentSection);
      continue;
    }

    if (!currentSection) {
      currentSection = { title: 'Introduction', subtitle: '', id: 'section-0', items: [], firstCommand: 1 };
      sections.push(currentSection);
    }

    if (line.match(/^# /)) {
      currentSection.items.push({ type: 'note', text: line.slice(2) });
    } else if (line.match(/^> /)) {
      commandNum++;
      currentSection.items.push({ type: 'command', text: line.slice(2), num: commandNum });
    } else if (line.trim() === '') {
      currentSection.items.push({ type: 'blank' });
    } else {
      currentSection.items.push({ type: 'commentary', text: line });
    }
  }

  return { sections: sections, totalCommands: commandNum };
}

/* ---- Parse transcript ---- */
function parseTranscript(transcriptText, commandsText) {
  var commands = commandsText.split('\n').filter(function(l) { return l.trim(); });
  var lines = transcriptText.split('\n');

  // Find first > line
  var firstPrompt = -1;
  for (var i = 0; i < lines.length; i++) {
    if (lines[i].match(/^>/)) { firstPrompt = i; break; }
  }

  // Preamble = everything before first >
  var preamble = firstPrompt > 0 ? lines.slice(0, firstPrompt).join('\n').trim() : '';

  // Split into steps at each > line
  var steps = [];
  var promptIndices = [];
  for (var i = 0; i < lines.length; i++) {
    if (lines[i].match(/^>/)) promptIndices.push(i);
  }

  for (var p = 0; p < promptIndices.length && p < commands.length; p++) {
    var promptLine = lines[promptIndices[p]];
    var immediateText = promptLine.slice(1); // text after >

    // Response = lines between this > and the next >
    var startLine = promptIndices[p] + 1;
    var endLine = (p + 1 < promptIndices.length) ? promptIndices[p + 1] : lines.length;
    var responseLines = lines.slice(startLine, endLine);

    // Combine immediate text with subsequent lines
    var fullResponse = [];
    if (immediateText.trim()) fullResponse.push(immediateText);
    for (var r = 0; r < responseLines.length; r++) {
      fullResponse.push(responseLines[r]);
    }

    // Trim trailing blank lines
    while (fullResponse.length > 0 && fullResponse[fullResponse.length - 1].trim() === '') {
      fullResponse.pop();
    }

    steps.push({
      num: p + 1,
      command: commands[p],
      response: fullResponse
    });
  }

  return { preamble: preamble, steps: steps };
}

/* ---- Classify response lines for syntax highlighting ---- */
function classifyLine(line, lineIndex, allLines) {
  // Score messages
  if (line.match(/\[Your score/i)) return 'score';
  // Room names: a line that is the first non-empty line in the response,
  // or follows a blank line, and is a short capitalized string
  if (lineIndex === 0 && line.trim() && !line.match(/^[\[\(]/) && line.length < 80) {
    // Check if it looks like a room name (Title Case, no period at end)
    if (line.trim().match(/^[A-Z]/) && !line.trim().match(/\.\s*$/)) {
      // Could be a room name — check if next line is blank or starts with "You are"
      var nextLine = (lineIndex + 1 < allLines.length) ? allLines[lineIndex + 1] : '';
      if (nextLine.match(/^You are |^You're |^$|^This is |^There is /)) return 'room';
    }
  }
  return 'normal';
}

function renderResponseLine(line, lineIndex, allLines) {
  var type = classifyLine(line, lineIndex, allLines);
  if (type === 'score') return '<span class="score-line">' + esc(line) + '</span>';
  if (type === 'room') return '<span class="room-name">' + esc(line) + '</span>';
  return esc(line);
}

/* ---- Render Commands mode ---- */
function renderCommands(guideData, rawText) {
  var html = '';
  html += '<div class="spoiler-notice"><strong>Spoiler Warning:</strong> This walkthrough reveals all puzzle solutions and the complete path to victory.</div>';

  if (guideData) {
    for (var s = 0; s < guideData.sections.length; s++) {
      var sec = guideData.sections[s];
      html += '<div class="section-header" id="' + sec.id + '">' + esc(sec.title);
      if (sec.subtitle) html += '<span class="section-subtitle">' + esc(sec.subtitle) + '</span>';
      html += '</div>';

      for (var j = 0; j < sec.items.length; j++) {
        var item = sec.items[j];
        if (item.type === 'command') {
          html += '<div class="command-line"><span class="command-num">' + item.num + '</span><span class="command-prompt">&gt;</span><span class="command-text">' + esc(item.text) + '</span></div>';
        }
      }
    }
  } else {
    html += '<div class="raw-view">';
    var lines = rawText.split('\n');
    var num = 0;
    for (var i = 0; i < lines.length; i++) {
      var line = lines[i].trim();
      if (!line) continue;
      num++;
      html += '<div class="command-line"><span class="command-num">' + num + '</span><span class="command-prompt">&gt;</span><span class="command-text">' + esc(line) + '</span></div>';
    }
    html += '</div>';
  }

  return html;
}

/* ---- Render Game Text mode ---- */
function renderTranscript(data, sectionMap) {
  var html = '';
  html += '<div class="spoiler-notice"><strong>Spoiler Warning:</strong> This is the complete game transcript showing all commands and responses.</div>';

  if (data.preamble) {
    html += '<div class="transcript-preamble">' + esc(data.preamble) + '</div>';
  }

  var sectionIdx = 0;
  for (var i = 0; i < data.steps.length; i++) {
    var step = data.steps[i];

    // Insert section header if this step starts a new section
    while (sectionIdx < sectionMap.length && sectionMap[sectionIdx].firstCommand <= step.num) {
      var sec = sectionMap[sectionIdx];
      html += '<div class="section-header" id="' + sec.id + '">' + esc(sec.title);
      if (sec.subtitle) html += '<span class="section-subtitle">' + esc(sec.subtitle) + '</span>';
      html += '</div>';
      sectionIdx++;
    }

    html += '<div class="transcript-step" id="step-' + step.num + '">';
    html += '<div class="step-command">';
    html += '<span class="command-num">' + step.num + '</span>';
    html += '<span class="command-prompt">&gt;</span>';
    html += '<span class="command-text">' + esc(step.command) + '</span>';
    html += '</div>';

    if (step.response.length > 0) {
      var responseHtml = '';
      for (var r = 0; r < step.response.length; r++) {
        responseHtml += renderResponseLine(step.response[r], r, step.response) + '\n';
      }
      html += '<div class="response">' + responseHtml + '</div>';
    }
    html += '</div>';
  }

  return html;
}

/* ---- Render Replay mode (initial empty container) ---- */
function renderReplayContainer(data) {
  var html = '';
  html += '<div id="replay-output"></div>';
  return html;
}

/* ---- Replay engine ---- */
function replayRenderStep(stepIndex, instant) {
  var output = document.getElementById('replay-output');
  if (!output || !transcriptData) return;

  var step = transcriptData.steps[stepIndex];
  if (!step) return;

  var stepEl = document.createElement('div');
  stepEl.className = 'transcript-step';
  stepEl.id = 'replay-s-' + step.num;

  var cmdEl = document.createElement('div');
  cmdEl.className = 'step-command';
  cmdEl.innerHTML = '<span class="command-num">' + step.num + '</span>' +
    '<span class="command-prompt">&gt;</span>' +
    '<span class="command-text" id="replay-cmd-' + step.num + '"></span>';
  stepEl.appendChild(cmdEl);

  var respEl = document.createElement('div');
  respEl.className = 'response';
  respEl.id = 'replay-resp-' + step.num;
  stepEl.appendChild(respEl);

  output.appendChild(stepEl);

  if (instant) {
    // Render instantly (for jumping)
    var cmdSpan = document.getElementById('replay-cmd-' + step.num);
    cmdSpan.textContent = step.command;
    var respHtml = '';
    for (var r = 0; r < step.response.length; r++) {
      respHtml += renderResponseLine(step.response[r], r, step.response) + '\n';
    }
    respEl.innerHTML = respHtml;
    return Promise.resolve();
  }

  // Animated render
  return animateStep(step);
}

function animateStep(step) {
  return new Promise(function(resolve) {
    var cmdSpan = document.getElementById('replay-cmd-' + step.num);
    var respEl = document.getElementById('replay-resp-' + step.num);
    if (!cmdSpan || !respEl) { resolve(); return; }

    var wrap = document.getElementById('content-wrap');

    // Phase 1: Type command character by character
    var charDelay = 50 / replaySpeed;
    var cmdText = step.command;
    replayPhase = 'typing';
    replayTypingIndex = 0;

    // Add blinking cursor
    var cursor = document.createElement('span');
    cursor.className = 'typing-cursor';
    cmdSpan.parentNode.appendChild(cursor);

    function typeChar() {
      if (!replayPlaying && replayPhase === 'typing') {
        // Paused — wait
        replayTimer = setTimeout(typeChar, 50);
        return;
      }
      if (replayTypingIndex < cmdText.length) {
        cmdSpan.textContent = cmdText.slice(0, replayTypingIndex + 1);
        replayTypingIndex++;
        scrollToBottom();
        replayTimer = setTimeout(typeChar, charDelay);
      } else {
        // Remove cursor
        if (cursor.parentNode) cursor.parentNode.removeChild(cursor);
        // Phase 2: Brief pause then show response
        replayPhase = 'response';
        replayTimer = setTimeout(function() { showResponse(0); }, 200 / replaySpeed);
      }
    }

    // Phase 3: Reveal response lines with stagger
    var responseLines = step.response;
    replayResponseIndex = 0;

    function showResponse(lineIdx) {
      if (!replayPlaying && replayPhase === 'response') {
        replayTimer = setTimeout(function() { showResponse(lineIdx); }, 50);
        return;
      }
      if (lineIdx < responseLines.length) {
        var lineSpan = document.createElement('div');
        lineSpan.className = 'response-line-fade';
        lineSpan.innerHTML = renderResponseLine(responseLines[lineIdx], lineIdx, responseLines);
        respEl.appendChild(lineSpan);

        // Trigger fade-in
        requestAnimationFrame(function() {
          requestAnimationFrame(function() {
            lineSpan.classList.add('visible');
          });
        });

        scrollToBottom();
        var lineDelay = 30 / replaySpeed;
        replayTimer = setTimeout(function() { showResponse(lineIdx + 1); }, lineDelay);
      } else {
        // Phase 4: Reading pause
        replayPhase = 'pause';
        var pauseTime = 800 + (responseLines.length * 20);
        pauseTime = Math.max(500, Math.min(3000, pauseTime));
        pauseTime = pauseTime / replaySpeed;
        replayTimer = setTimeout(function() {
          replayPhase = 'idle';
          resolve();
        }, pauseTime);
      }
    }

    function scrollToBottom() {
      if (wrap) {
        var stepEl = document.getElementById('replay-s-' + step.num);
        if (stepEl) stepEl.scrollIntoView({ block: 'end', behavior: 'smooth' });
      }
    }

    typeChar();
  });
}

function replayGo() {
  if (!transcriptData || !replayPlaying) return;

  replayStep++;
  if (replayStep >= transcriptData.steps.length) {
    replayPlaying = false;
    updateReplayUI();
    return;
  }

  updateReplayUI();
  replayRenderStep(replayStep, false).then(function() {
    if (replayPlaying) replayGo();
  });
}

function replayPlay() {
  if (replayPlaying) {
    replayPlaying = false;
  } else {
    replayPlaying = true;
    if (replayStep >= transcriptData.steps.length - 1 && replayPhase === 'idle') {
      // At end, restart
      replayStep = -1;
      document.getElementById('replay-output').innerHTML = '';
      if (transcriptData.preamble) {
        document.getElementById('replay-output').innerHTML =
          '<div class="transcript-preamble">' + esc(transcriptData.preamble) + '</div>';
      }
    }
    if (replayPhase === 'idle') {
      replayGo();
    }
  }
  updateReplayUI();
}

function replayStepForward() {
  if (!transcriptData) return;
  var wasPlaying = replayPlaying;
  replayPlaying = false;
  clearTimeout(replayTimer);
  replayPhase = 'idle';

  replayStep++;
  if (replayStep >= transcriptData.steps.length) {
    replayStep = transcriptData.steps.length - 1;
    updateReplayUI();
    return;
  }

  // Complete current step instantly if partially rendered
  var existing = document.getElementById('replay-s-' + transcriptData.steps[replayStep].num);
  if (existing) existing.remove();

  replayRenderStep(replayStep, true);
  updateReplayUI();
  var stepEl = document.getElementById('replay-s-' + transcriptData.steps[replayStep].num);
  if (stepEl) stepEl.scrollIntoView({ block: 'end', behavior: 'smooth' });
}

function replayStepBack() {
  if (!transcriptData || replayStep <= 0) return;
  replayPlaying = false;
  clearTimeout(replayTimer);
  replayPhase = 'idle';

  // Remove current step's element
  var cur = document.getElementById('replay-s-' + transcriptData.steps[replayStep].num);
  if (cur) cur.remove();

  replayStep--;
  updateReplayUI();
  var stepEl = document.getElementById('replay-s-' + transcriptData.steps[replayStep].num);
  if (stepEl) stepEl.scrollIntoView({ block: 'end', behavior: 'smooth' });
}

function replayJumpTo(stepIndex) {
  if (!transcriptData) return;
  replayPlaying = false;
  clearTimeout(replayTimer);
  replayPhase = 'idle';

  // Re-render all steps up to stepIndex instantly
  var output = document.getElementById('replay-output');
  output.innerHTML = '';

  if (transcriptData.preamble) {
    output.innerHTML = '<div class="transcript-preamble">' + esc(transcriptData.preamble) + '</div>';
  }

  stepIndex = Math.max(0, Math.min(stepIndex, transcriptData.steps.length - 1));

  for (var i = 0; i <= stepIndex; i++) {
    replayRenderStep(i, true);
  }

  replayStep = stepIndex;
  updateReplayUI();
  var stepEl = document.getElementById('replay-s-' + transcriptData.steps[replayStep].num);
  if (stepEl) stepEl.scrollIntoView({ block: 'end', behavior: 'smooth' });
}

function setReplaySpeed(speed) {
  replaySpeed = speed;
  localStorage.setItem('zork1-replay-speed', String(speed));
  document.querySelectorAll('.speed-btn').forEach(function(btn) {
    btn.classList.toggle('active', parseFloat(btn.dataset.speed) === speed);
  });
}

function updateReplayUI() {
  if (!transcriptData) return;
  var btn = document.getElementById('replay-play');
  btn.innerHTML = replayPlaying ? '&#10074;&#10074; Pause' : '&#9654; Play';

  var total = transcriptData.steps.length;
  var cur = Math.max(0, replayStep + 1);
  document.getElementById('replay-step').textContent = 'Step ' + cur + '/' + total;

  var pct = total > 0 ? (cur / total * 100) : 0;
  document.getElementById('progress-fill').style.width = pct + '%';
}

/* ---- Build sidebar nav ---- */
function buildNav(sections) {
  var nav = document.getElementById('nav');
  var html = '';
  for (var s = 0; s < sections.length; s++) {
    var sec = sections[s];
    html += '<a class="nav-item" data-section="' + sec.id + '" data-first-cmd="' + sec.firstCommand + '">' + esc(sec.title) + '</a>';
  }
  nav.innerHTML = html;

  nav.addEventListener('click', function(e) {
    var a = e.target.closest('.nav-item');
    if (!a) return;
    e.preventDefault();

    nav.querySelectorAll('.nav-item').forEach(function(el) { el.classList.remove('active'); });
    a.classList.add('active');

    var sectionId = a.getAttribute('data-section');
    var firstCmd = parseInt(a.getAttribute('data-first-cmd'));

    if (currentView === 'replay') {
      // Jump replay to that section
      var stepIdx = firstCmd - 1;
      replayJumpTo(stepIdx);
    } else {
      // Scroll to section header or step
      var target = document.getElementById(sectionId);
      if (target) {
        target.scrollIntoView({ block: 'start', behavior: 'smooth' });
      }
    }
  });
}

/* ---- Update active nav on scroll ---- */
function setupScrollSpy() {
  var wrap = document.getElementById('content-wrap');
  var nav = document.getElementById('nav');

  wrap.addEventListener('scroll', function() {
    if (currentView === 'replay') return;
    var headers = wrap.querySelectorAll('.section-header');
    var active = null;
    for (var i = 0; i < headers.length; i++) {
      var rect = headers[i].getBoundingClientRect();
      if (rect.top <= 120) active = headers[i].id;
    }
    if (active) {
      nav.querySelectorAll('.nav-item').forEach(function(el) {
        if (el.getAttribute('data-section') === active) {
          el.classList.add('active');
        } else {
          el.classList.remove('active');
        }
      });
    }
  });
}

/* ---- Search ---- */
var searchHits = [];
var currentHit = -1;

function clearSearch() {
  document.querySelectorAll('.search-hit').forEach(function(el) {
    el.outerHTML = el.textContent;
  });
  searchHits = [];
  currentHit = -1;
}

function highlightMatches(el, query) {
  var walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT);
  var lower = query.toLowerCase();
  var nodes = [];
  while (walker.nextNode()) nodes.push(walker.currentNode);

  nodes.forEach(function(node) {
    var text = node.textContent;
    var idx = text.toLowerCase().indexOf(lower);
    if (idx === -1) return;

    var before = text.slice(0, idx);
    var match = text.slice(idx, idx + query.length);
    var after = text.slice(idx + query.length);

    var span = document.createElement('span');
    span.className = 'search-hit';
    span.textContent = match;

    var parent = node.parentNode;
    if (before) parent.insertBefore(document.createTextNode(before), node);
    parent.insertBefore(span, node);
    if (after) parent.insertBefore(document.createTextNode(after), node);
    parent.removeChild(node);

    if (after.toLowerCase().includes(lower)) {
      var afterNode = span.nextSibling;
      if (afterNode && afterNode.nodeType === Node.TEXT_NODE) {
        var temp = document.createElement('span');
        temp.appendChild(afterNode.cloneNode(true));
        parent.replaceChild(temp, afterNode);
        highlightMatches(temp, query);
        while (temp.firstChild) parent.insertBefore(temp.firstChild, temp);
        parent.removeChild(temp);
      }
    }
  });
}

function doSearch(query) {
  clearSearch();
  if (!query || query.length < 2) return;

  var wrap = document.getElementById('content-wrap');
  var els = wrap.querySelectorAll('.command-text, .response, .section-header, .transcript-preamble');

  els.forEach(function(el) {
    if (el.textContent.toLowerCase().includes(query.toLowerCase())) {
      highlightMatches(el, query);
    }
  });

  searchHits = Array.from(document.querySelectorAll('.search-hit'));
  if (searchHits.length > 0) {
    currentHit = 0;
    searchHits[0].classList.add('search-current');
    searchHits[0].scrollIntoView({ block: 'center' });
  }
}

function nextHit() {
  if (searchHits.length === 0) return;
  searchHits[currentHit].classList.remove('search-current');
  currentHit = (currentHit + 1) % searchHits.length;
  searchHits[currentHit].classList.add('search-current');
  searchHits[currentHit].scrollIntoView({ block: 'center' });
}

function prevHit() {
  if (searchHits.length === 0) return;
  searchHits[currentHit].classList.remove('search-current');
  currentHit = (currentHit - 1 + searchHits.length) % searchHits.length;
  searchHits[currentHit].classList.add('search-current');
  searchHits[currentHit].scrollIntoView({ block: 'center' });
}

/* ---- View switching ---- */
function stopReplay() {
  replayPlaying = false;
  clearTimeout(replayTimer);
  replayPhase = 'idle';
  replayStep = -1;
}

function showCommands() {
  stopReplay();
  currentView = 'commands';
  document.getElementById('content-wrap').innerHTML = renderCommands(guideData, rawData);
  var lines = rawData ? rawData.split('\n').filter(function(l) { return l.trim(); }) : [];
  document.getElementById('step-count').textContent = (guideData ? guideData.totalCommands : lines.length) + ' steps';
  document.getElementById('btn-commands').classList.add('active');
  document.getElementById('btn-transcript').classList.remove('active');
  document.getElementById('btn-replay').classList.remove('active');
  document.getElementById('replay-controls').style.display = 'none';
  if (guideData) buildNav(guideData.sections);
  else document.getElementById('nav').innerHTML = '';
  setupScrollSpy();
  clearSearch();
  var searchVal = document.getElementById('search').value;
  if (searchVal && searchVal.length >= 2) doSearch(searchVal);
}

function showTranscript() {
  stopReplay();
  if (!transcriptData) return;
  currentView = 'transcript';
  var sectionMap = guideData ? guideData.sections : [];
  document.getElementById('content-wrap').innerHTML = renderTranscript(transcriptData, sectionMap);
  document.getElementById('step-count').textContent = transcriptData.steps.length + ' steps';
  document.getElementById('btn-commands').classList.remove('active');
  document.getElementById('btn-transcript').classList.add('active');
  document.getElementById('btn-replay').classList.remove('active');
  document.getElementById('replay-controls').style.display = 'none';
  if (guideData) buildNav(guideData.sections);
  setupScrollSpy();
  clearSearch();
  var searchVal = document.getElementById('search').value;
  if (searchVal && searchVal.length >= 2) doSearch(searchVal);
}

function showReplay() {
  stopReplay();
  if (!transcriptData) return;
  currentView = 'replay';
  document.getElementById('content-wrap').innerHTML = renderReplayContainer(transcriptData);
  document.getElementById('step-count').textContent = transcriptData.steps.length + ' steps';
  document.getElementById('btn-commands').classList.remove('active');
  document.getElementById('btn-transcript').classList.remove('active');
  document.getElementById('btn-replay').classList.add('active');
  document.getElementById('replay-controls').style.display = 'flex';

  // Show preamble immediately
  var output = document.getElementById('replay-output');
  if (transcriptData.preamble) {
    output.innerHTML = '<div class="transcript-preamble">' + esc(transcriptData.preamble) + '</div>';
  }

  replayStep = -1;
  updateReplayUI();

  if (guideData) buildNav(guideData.sections);
  clearSearch();
}

/* ---- Init ---- */
async function init() {
  var wrap = document.getElementById('content-wrap');

  try {
    var results = await Promise.all([
      fetch(GUIDE_URL).then(function(r) { return r.ok ? r.text() : null; }),
      fetch(RAW_URL).then(function(r) { return r.ok ? r.text() : null; }),
      fetch(TRANSCRIPT_URL).then(function(r) { return r.ok ? r.text() : null; })
    ]);

    if (results[0]) guideData = parseGuide(results[0]);
    rawData = results[1];
    transcriptRaw = results[2];

    if (transcriptRaw && rawData) {
      transcriptData = parseTranscript(transcriptRaw, rawData);
    }

    if (rawData || guideData) {
      showCommands();
    } else {
      wrap.innerHTML = '<div class="error-msg">Failed to load walkthrough files.</div>';
      return;
    }

    // Disable transcript/replay buttons if no transcript
    if (!transcriptData) {
      document.getElementById('btn-transcript').disabled = true;
      document.getElementById('btn-transcript').style.opacity = '0.4';
      document.getElementById('btn-transcript').style.cursor = 'default';
      document.getElementById('btn-replay').disabled = true;
      document.getElementById('btn-replay').style.opacity = '0.4';
      document.getElementById('btn-replay').style.cursor = 'default';
    }
  } catch (e) {
    wrap.innerHTML = '<div class="error-msg">Failed to load walkthrough. ' + esc(e.message) + '</div>';
    return;
  }

  // Toggle buttons
  document.getElementById('btn-commands').addEventListener('click', showCommands);
  document.getElementById('btn-transcript').addEventListener('click', function() {
    if (transcriptData) showTranscript();
  });
  document.getElementById('btn-replay').addEventListener('click', function() {
    if (transcriptData) showReplay();
  });

  // Replay controls
  document.getElementById('replay-play').addEventListener('click', replayPlay);
  document.getElementById('replay-back').addEventListener('click', replayStepBack);
  document.getElementById('replay-fwd').addEventListener('click', replayStepForward);

  // Progress bar click
  document.getElementById('progress-bar').addEventListener('click', function(e) {
    if (!transcriptData) return;
    var rect = this.getBoundingClientRect();
    var pct = (e.clientX - rect.left) / rect.width;
    var stepIdx = Math.round(pct * (transcriptData.steps.length - 1));
    replayJumpTo(stepIdx);
  });

  // Speed buttons
  document.querySelectorAll('.speed-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      setReplaySpeed(parseFloat(this.dataset.speed));
    });
  });
  // Set initial speed button state
  setReplaySpeed(replaySpeed);

  // Search
  var searchInput = document.getElementById('search');
  var debounce;
  searchInput.addEventListener('input', function() {
    clearTimeout(debounce);
    var self = this;
    debounce = setTimeout(function() { doSearch(self.value); }, 200);
  });

  searchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      if (e.shiftKey) prevHit(); else nextHit();
    }
    if (e.key === 'Escape') {
      clearSearch();
      this.value = '';
      this.blur();
    }
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // Ctrl+F for search
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
      e.preventDefault();
      searchInput.focus();
      searchInput.select();
      return;
    }

    // Don't handle shortcuts if focused on input
    if (document.activeElement === searchInput) return;

    if (currentView === 'replay') {
      if (e.key === ' ') {
        e.preventDefault();
        replayPlay();
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        replayStepForward();
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        replayStepBack();
      } else if (e.key === '1') {
        setReplaySpeed(0.5);
      } else if (e.key === '2') {
        setReplaySpeed(1);
      } else if (e.key === '3') {
        setReplaySpeed(2);
      } else if (e.key === '4') {
        setReplaySpeed(4);
      }
    }
  });

  // Scroll to hash on load
  if (location.hash) {
    var el = document.querySelector(location.hash);
    if (el) setTimeout(function() { el.scrollIntoView({ block: 'start' }); }, 100);
  }
}

init();
</script>

</body>
</html>
